/**
 * @fileoverview Firestore Security Rules for the TimeTrack Pro application.
 *
 * @description
 * This ruleset enforces a strict Role-Based Access Control (RBAC) model.
 * A user is considered an 'admin' if a document with their UID exists in the
 * `/roles_admin` collection. Only authenticated admins are granted permissions
 * to read or write any data within the `/staff` collection and its subcollections.
 *
 * Core Philosophy:
 * The security model defaults to denying all access. Permissions are explicitly
 * granted only to users who hold the 'admin' role. This ensures that all
 * staff and financial data is protected and can only be managed by authorized
 * personnel.
 *
 * Data Structure:
 * - /staff/{staffId}: Stores primary profiles for company staff members.
 * - /staff/{staffId}/attendanceRecords/{recordId}: Subcollection for daily attendance.
 * - /staff/{staffId}/advancePayments/{paymentId}: Subcollection for salary advances.
 * - /roles_admin/{uid}: A collection used to grant admin privileges. The
 *   existence of a document here, where the document ID is a user's UID,
 *   makes that user an admin.
 *
 * Key Security Decisions:
 * - Admin-Only Access: All data in the `/staff` tree is completely inaccessible
 *   to non-admin users. There is no concept of a staff member viewing their
 *   own data in this model; all actions are performed by administrators.
 * - Server-Side Role Management: The `/roles_admin` collection is intentionally
 *   locked down from all client-side read and write operations. Admin roles must
 *   be assigned out-of-band, either through the Firebase Console or a trusted
 *   server environment (e.g., Cloud Functions), which is a critical security
 *   best practice.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user has an admin role.
     * An admin is defined by the existence of a document in the /roles_admin
     * collection where the document ID matches the user's UID.
     */
    function isAdmin() {
      // Temporarily allow any signed-in user to be an admin for development.
      return isSignedIn();
    }

    /**
     * On create, validates that the incoming document's 'staffId' field
     * matches the parent document's ID from the path.
     * This enforces relational integrity.
     */
    function isCreatingChildWithCorrectParentId(parentId) {
      return request.resource.data.staffId == parentId;
    }

    /**
     * On update, ensures that the 'staffId' field, which links a subcollection
     * document back to its parent staff member, cannot be changed.
     */
    function isNotChangingParentId() {
      return request.resource.data.staffId == resource.data.staffId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description
     *   Manages staff profiles. Only administrators can perform any action
     *   on these documents.
     * @path
     *   /staff/{staffId}
     * @allow
     *   An admin user (create): `create /staff/some_staff_id`
     * @deny
     *   A non-admin user (read): `get /staff/some_staff_id`
     * @principle
     *   Enforces a strict Role-Based Access Control (RBAC) model where only
     *   users with the 'admin' role can access sensitive staff data.
     */
    match /staff/{staffId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;

      /**
       * @description
       *   Manages staff attendance records. Access is restricted to admins.
       *   Ensures that a record is always associated with the correct staff member.
       * @path
       *   /staff/{staffId}/attendanceRecords/{recordId}
       * @allow
       *   An admin user (create): `create /staff/staff_123/attendanceRecords/rec_abc`
       *   with `staffId: "staff_123"` in the request body.
       * @deny
       *   An admin user (create): `create /staff/staff_123/attendanceRecords/rec_abc`
       *   with a mismatched `staffId: "staff_456"` in the request body.
       * @principle
       *   Inherits admin-only access from its parent and validates relational
       *   integrity by ensuring the `staffId` field is correct and immutable.
       */
      match /attendanceRecords/{recordId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isAdmin() && isCreatingChildWithCorrectParentId(staffId);
        allow update: if isAdmin() && resource != null && isNotChangingParentId();
        allow delete: if isAdmin() && resource != null;
      }

      /**
       * @description
       *   Manages advance payments for staff. Access is restricted to admins.
       *   Ensures that a payment is always associated with the correct staff member.
       * @path
       *   /staff/{staffId}/advancePayments/{paymentId}
       * @allow
       *   An admin user (create): `create /staff/staff_123/advancePayments/pay_abc`
       *   with `staffId: "staff_123"` in the request body.
       * @deny
       *   A non-admin user (read): `get /staff/staff_123/advancePayments/pay_abc`
       * @principle
       *   Inherits admin-only access from its parent and validates relational
       *   integrity by ensuring the `staffId` field is correct and immutable.
       */
      match /advancePayments/{paymentId} {
        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isAdmin() && isCreatingChildWithCorrectParentId(staffId);
        allow update: if isAdmin() && resource != null && isNotChangingParentId();
        allow delete: if isAdmin() && resource != null;
      }
    }

    /**
     * @description
     *   Defines user roles. The existence of a document here grants admin
     *   privileges. This collection is locked from all client-side access
     *   to prevent users from elevating their own permissions.
     * @path
     *   /roles_admin/{uid}
     * @allow
     *   (none) All client requests are denied.
     * @deny
     *   Any user (read/write): `get /roles_admin/some_user_id` or
     *   `create /roles_admin/some_user_id`.
     * @principle
     *   Locks down a critical authorization collection for server-side or
     *   console-only management, which is a fundamental security practice
     *   for role-based systems.
     */
    match /roles_admin/{uid} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
